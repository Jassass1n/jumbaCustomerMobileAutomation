package pages.accountpage;

import config.ConfigurationManager;
import helpers.ElementHelper;
import helpers.PropertiesLoader;
import helpers.ToastHelper;
import io.appium.java_client.AppiumDriver;
import io.appium.java_client.MobileBy;
import io.qameta.allure.Allure;
import org.openqa.selenium.By;
import org.openqa.selenium.*;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import pages.BasePage;
import pages.FulfilmentDetails;
import pages.login.LoginPage;
import java.time.Duration;
import java.util.Properties;

import static helpers.ElementHelper.clickElement;

public class AccountPage extends BasePage {
    private static final Logger logger = LoggerFactory.getLogger(FulfilmentDetails.class);
    private final Properties configProperties;
    private final WebDriverWait wait;
    private final LoginPage loginPage;
    private final OrdersPage ordersPage;

    public AccountPage(AppiumDriver driver) {
        super(driver);
        this.configProperties = PropertiesLoader.loadProperties("src/main/resources/config.properties");
        this.wait = new WebDriverWait(driver, Duration.ofSeconds(15));
        this.loginPage = new LoginPage(driver);
        this.ordersPage = new OrdersPage(driver);
    }

    public boolean isAccountPageDisplayed() {
        String locatorValue = configProperties.getProperty("accountPageTitle.uiautomator");
        return ElementHelper.isElementDisplayed(locatorValue);
    }

    public boolean waitForPageLoad(int timeoutSeconds) {
        try {
            new WebDriverWait(driver, Duration.ofSeconds(timeoutSeconds))
                    .until(d -> {
                        WebElement element = d.findElement(getLocator("accountPageTitle.uiautomator"));
                        return element != null && element.isDisplayed();
                    });
            return true;
        } catch (Exception e) {
            logger.error("‚ùå Account Page not loaded: " + e.getMessage());
            Allure.step("‚ùå Account Page not loaded: " + e.getMessage());
            return false;
        }
    }
    /** Wait for Notifications page to load */
    public boolean waitForNotificationsPageLoad(int timeoutSeconds) {
        try {
            new WebDriverWait(driver, Duration.ofSeconds(timeoutSeconds))
                    .until(d -> {
                        WebElement element = d.findElement(getLocator("notificationsPreferencePageTitle.text"));
                        return element != null && element.isDisplayed();
                    });
            return true;
        } catch (Exception e) {
            logger.error("‚ùå Notifications Page not loaded: " + e.getMessage());
            Allure.step("‚ùå Notifications Page not loaded: " + e.getMessage());
            return false;
        }
    }
    /** Profile page should be displayed */
    public boolean isProfilePageDisplayed() {
        By locator = getLocator("profilePageTitle.text");
        return ElementHelper.isElementDisplayed(locator);
    }

    /** Opens the Notification Preferences page */
    public void clickNotificationPreferencesButton() {
        By locator = getLocator("notificationsPreference.text");
        clickElement(locator);
    }

    /** Notification Preferences page should be displayed */
    public boolean isNotificationPreferencesPageDisplayed() {
        By locator = getLocator("notificationsPreferencePageTitle.text");
        return ElementHelper.isElementDisplayed(locator);
    }

    /** Toggles all notification preferences */
    public void toggleAllNotificationToggles() {
        String[] toggleKeys = {
                "accountVerifiedBtn.xpath",
                "orderStatusBtn.xpath",
                "paymentNotificationBtn.xpath",
                "jengwaUpdatesBtn.xpath"
        };

        for (String key : toggleKeys) {
            try {
                System.out.println("üîÅ Toggling: " + key);
                By locator = getLocator(key);
                clickElement(locator);
            } catch (Exception e) {
                System.out.println("‚ùå Failed to toggle " + key + ": " + e.getMessage());
            }
        }
    }

    /** Clicks Update Preferences and verifies the toast */
    public boolean clickUpdatePreferencesButtonAndVerifyToast() {
        String expectedToast = configProperties.getProperty("notificationSuccessMessage.text");
        By buttonLocator = getLocator("updatePreferences.text");

        try {
            Allure.step("üîò Clicking 'Update Preferences' button");
            clickElement(buttonLocator);

            ToastHelper toastHelper = new ToastHelper(driver);
            boolean isToastDisplayed = toastHelper.verifyToastVisible(expectedToast, 5);

            if (isToastDisplayed) {
                logger.info("‚úÖ Toast displayed after updating preferences: {}", expectedToast);
                Allure.step("‚úÖ Toast displayed: " + expectedToast);
                return true;
            } else {
                logger.warn("‚ùå Expected toast not displayed: {}", expectedToast);
                Allure.step("‚ùå Expected toast not found: " + expectedToast);
                return false;
            }
        } catch (Exception e) {
            logger.error("‚ùå Error verifying toast after clicking update preferences", e);
            Allure.step("‚ùå Exception occurred while checking toast: " + e.getMessage());
            return false;
        }
    }

    /** Logs out and verifies redirect to login page */
    public void clickLogoutButton() {
        By logoutBtn = getLocator("logoutBtn.text");
        By loginButton = getLocator("loginButton.text");
        By loginPageTitle = getLocator("loginPageTitle.text"); // Ensure this is in your config

        try {
            Allure.step("üîò Clicking Logout button");
            wait.until(ExpectedConditions.elementToBeClickable(logoutBtn)).click();
            logger.info("‚úÖ Clicked Logout button");

            Allure.step("üîé Verifying Login button is visible after logout");
            if (wait.until(ExpectedConditions.visibilityOfElementLocated(loginButton)).isDisplayed()) {
                logger.info("‚úÖ Login button is displayed after logout");

                Allure.step("üîò Clicking Login button");
                wait.until(ExpectedConditions.elementToBeClickable(loginButton)).click();
                logger.info("‚úÖ Clicked Login button");

                Allure.step("üîé Verifying Login page is displayed");
                if (wait.until(ExpectedConditions.visibilityOfElementLocated(loginPageTitle)).isDisplayed()) {
                    logger.info("‚úÖ Verified login page is displayed");
                    Allure.step("‚úÖ Login page displayed successfully");
                } else {
                    logger.error("‚ùå Login page not displayed after clicking login button");
                    Allure.step("‚ùå Login page not displayed after clicking login button");
                    throw new RuntimeException("Login page not displayed after logout");
                }
            } else {
                logger.error("‚ùå Login button not visible after logout");
                Allure.step("‚ùå Login button not visible after logout");
                throw new RuntimeException("Login button not visible after logout");
            }
        } catch (Exception e) {
            logger.error("‚ùå Logout and login redirection failed", e);
            Allure.step("‚ùå Exception during logout/login redirection: " + e.getMessage());
            throw e;
        }
    }

    private By getProfilePhoneNumberLocator() {
        String rawNumber = ConfigurationManager.getProperty("phoneNumber");
        String fullNumber = "+254" + rawNumber;

        return MobileBy.AndroidUIAutomator("new UiSelector().text(\"" + fullNumber + "\")");
    }

    /**
     * Verifies if the logged-in phone number shown on profile page matches expected full number
     * @return true if matches, false otherwise
     */
    public boolean isLoggedInPhoneNumberCorrect() {
        try {
            By phoneNumberLocator = getProfilePhoneNumberLocator();
            String actualPhoneNumber = driver.findElement(phoneNumberLocator).getText().trim();

            String rawNumber = ConfigurationManager.getProperty("phoneNumber");
            String expectedPhoneNumber = "+254" + rawNumber;
            logger.info("üì± Expected: " + expectedPhoneNumber + " | Found: " + actualPhoneNumber);
            Allure.step("üì± Expected: " + expectedPhoneNumber + " | Found: " + actualPhoneNumber);

            return actualPhoneNumber.equals(expectedPhoneNumber);
        } catch (Exception e) {
            logger.error("‚ùå Error verifying phone number", e);
            Allure.step("‚ùå Exception occurred while verifying phone number: " + e.getMessage());
            return false;
        }
    }

    /**
     * Checks if profile page is displayed by checking if phone number element is visible
     * @return true if displayed, false otherwise
     */
    public boolean isAccountProfileDisplayed() {
        By phoneNumberLocator = getProfilePhoneNumberLocator();
        return ElementHelper.isElementDisplayed(phoneNumberLocator);
    }
    /**
     * Clicks login button on account page and verifies if login page is displayed
     * @return true if login page is displayed, false otherwise
     */
    public boolean clickLoginButton() {
        By loginButtonLocator = getLocator("loginButton.text");
        clickElement(loginButtonLocator);
        return loginPage.isLoginPageDisplayed();
    }



    public void clickOrdersButton() {
        By ordersButtonLocator = getLocator("ordersButton.accessibility");

        try {
            logger.info("üõí Clicking Orders button...");
            clickElement(ordersButtonLocator);

            if (ordersPage.isOrdersPageDisplayed()) {
                logger.info("‚úÖ Orders page displayed after click.");
                Allure.step("‚úÖ Orders page loaded after clicking Orders button.");
            } else {
                logger.warn("‚ö†Ô∏è Orders page not visible after clicking.");
                Allure.step("‚ö†Ô∏è Orders page did not appear.");
            }
        } catch (Exception e) {
            logger.error("‚ùå Failed to click Orders button: {}", e.getMessage());
            Allure.step("‚ùå Failed to click Orders button.", () -> {
                throw e;
            });
        }
    }


}

